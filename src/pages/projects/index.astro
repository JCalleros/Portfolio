---
import Base from "../../layouts/Base.astro";
import Nav from "../../components/Nav.astro";
import ScrollProgress from "../../components/ScrollProgress.astro";
import FX from "../../components/FX.astro";
import ProjectGalleryCard from "../../components/ProjectGalleryCard.astro";
import projects from "../../data/projects";

const featured = projects[0];
const rest = projects.slice(1);

const INITIAL = 3;
const MAX_TAGS = 6;
---
<Base>
  <a id="top"></a>
  <Nav />
  <ScrollProgress />
  <FX />

  <style is:global>
    [hidden]{display:none!important;}

    #gallery [data-extra]{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transform:translateY(8px) scale(.99);
      pointer-events:none;
      transition:
        max-height 200ms cubic-bezier(.25,.75,.25,1),
        opacity    160ms ease,
        transform  200ms cubic-bezier(.25,.75,.25,1);
      transition-delay:calc(var(--i,0)*18ms);
      scroll-margin-top:96px;
    }
    #gallery[data-expanded="true"] [data-extra]{
      max-height:1200px;
      opacity:1;
      transform:none;
      pointer-events:auto;
    }
    @media (prefers-reduced-motion: reduce){
      #gallery [data-extra],
      #gallery[data-expanded="true"] [data-extra]{ transition:none }
    }
  </style>

  <section class="section pb-6 md:pb-8" data-bg="projects">
    <header class="mb-4 reveal" data-reveal>
      <h1 class="text-3xl md:text-4xl font-bold tracking-tight">Case studies</h1>
      <p class="mt-2 opacity-90">Selected projects with outcomes, stack, and the story behind the work.</p>
    </header>

    {featured && (
      <a href={`/projects/${featured.slug}`} class="block reveal" data-reveal aria-label={`Open ${featured.title}`}>
        <article class="card overflow-hidden">
          <div class="grid gap-0 md:grid-cols-[1.2fr_1fr]">
            <figure class="relative aspect-[16/10] md:aspect-auto bg-white/5">
              <img
                src={featured.image}
                alt=""
                class="absolute inset-0 h-full w-full object-contain p-3"
                loading="eager"
                decoding="async"
                fetchpriority="high"
                sizes="(min-width:1024px) 66vw, 100vw"
              />
            </figure>
            <div class="p-6 md:p-8 flex flex-col">
              <h2 class="text-2xl font-semibold">{featured.title}</h2>
              <p class="mt-2 opacity-90">{featured.summary}</p>
              <div class="mt-3 flex flex-wrap gap-2">
                {(featured.tags || []).slice(0, MAX_TAGS).map((t: string) => <span class="tag">{t}</span>)}
                {(featured.tags?.length ?? 0) > MAX_TAGS && (
                  <span class="tag">+ {(featured.tags!.length - MAX_TAGS)} more</span>
                )}
              </div>
              <div class="mt-auto pt-4">
                <span class="btn btn-ghost">Read case study â†’</span>
              </div>
            </div>
          </div>
        </article>
      </a>
    )}
  </section>

  {rest.length > 0 && (
    <!-- smaller top padding to tighten the gap -->
    <section class="section pt-3 md:pt-4" data-bg="projects">
      <div class="mb-2 opacity-80 text-sm">More work</div>

      <div
        id="gallery"
        data-initial={INITIAL}
        data-expanded="false"
        class="mt-2 grid grid-cols-1 items-stretch gap-6 sm:grid-cols-2 lg:grid-cols-3"
      >
        {rest.map((p: any, i: number) => {
          const extra = i >= INITIAL;
          const idx   = i - INITIAL;
          return (
            <div data-extra={extra ? "true" : undefined} style={extra ? `--i:${Math.max(idx,0)}` : undefined}>
              <ProjectGalleryCard {...p} />
            </div>
          );
        })}
      </div>

      {rest.length > INITIAL && (
        <div class="mt-5 flex justify-center">
          <button
            id="reveal-more"
            class="btn btn-ghost"
            data-expanded="false"
            aria-controls="gallery"
            aria-expanded="false"
          >
            Show {rest.length - INITIAL} more
          </button>
        </div>
      )}
    </section>
  )}

  <script>
    (function () {
      var btn = document.getElementById('reveal-more');
      var gallery = document.getElementById('gallery');
      if (!btn || !gallery) return;

      var initial = Number(gallery.getAttribute('data-initial') || '0');
      var all = Array.prototype.slice.call(gallery.children);
      var extras = all.slice(initial);

      function updateLabel(expanded) {
        btn.textContent = expanded ? 'Show less' : ('Show ' + extras.length + ' more');
        btn.setAttribute('aria-expanded', String(expanded));
        btn.dataset.expanded = String(expanded);
        gallery.dataset.expanded = String(expanded);
        extras.forEach(function(el){
          var card = el.querySelector('article, a, [role]');
          if (card) card.setAttribute('aria-hidden', String(!expanded));
        });
      }

      function scrollToFirstExtra() {
        if (!extras.length) return;
        var prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        var delay = prefersReduced ? 0 : 220;
        requestAnimationFrame(function(){
          setTimeout(function(){
            extras[0].scrollIntoView({ block: 'start', behavior: 'smooth' });
          }, delay);
        });
      }

      updateLabel(false);

      btn.addEventListener('click', function () {
        var expanded = btn.dataset.expanded === 'true';
        var next = !expanded;
        updateLabel(next);
        if (next) {
          scrollToFirstExtra();
        } else {
          btn.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
      });
    })();
  </script>
</Base>
