---
const links = [
  { href: "/projects", label: "Projects", kind: "route" },   // dedicated page
  { href: "#experience", label: "Experience", kind: "hash" }, // landing sections
  { href: "#skills",     label: "Skills",     kind: "hash" },
  { href: "#contact",    label: "Contact",    kind: "hash" },
];
---
<nav class="sticky top-0 z-50">
  <div
    id="site-nav"
    class="transition-colors duration-300 backdrop-blur supports-[backdrop-filter]:bg-black/30"
    data-scrolled="false"
  >
    <div class="container-x py-3 flex items-center justify-between">
      <!-- Brand should always go home so it works from any page -->
      <a href="/" class="font-semibold tracking-tight">Jorge Calleros</a>

      <!-- desktop -->
      <ul class="hidden md:flex gap-4 text-sm">
        {links.map((l) => (
          <li>
            <a
              class="nav-link opacity-90 hover:opacity-100"
              href={l.href}
              data-kind={l.kind}
              aria-current="false"
            >
              {l.label}
            </a>
          </li>
        ))}
      </ul>

      <!-- mobile trigger -->
      <button
        class="md:hidden btn-icon"
        aria-label="Open menu"
        aria-controls="mobile-menu"
        aria-expanded="false"
        id="menu-btn"
        type="button"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <!-- mobile menu -->
    <div id="mobile-menu" class="md:hidden hidden border-t border-white/10">
      <ul class="container-x py-2 flex flex-col">
        {links.map((l) => (
          <li>
            <a
              class="block py-2 nav-link opacity-90 hover:opacity-100"
              href={l.href}
              data-kind={l.kind}
              aria-current="false"
            >
              {l.label}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </div>
</nav>

<script>
  // Scroll styling (adds subtle darkening & hairline)
  const bar = document.getElementById("site-nav");
  const onScroll = () => {
    const scrolled = window.scrollY > 6;
    bar.dataset.scrolled = scrolled ? "true" : "false";
    bar.style.boxShadow = scrolled ? "inset 0 -1px 0 rgba(255,255,255,.08)" : "none";
    bar.style.backgroundColor = scrolled ? "rgba(0,0,0,.42)" : "rgba(0,0,0,.30)";
  };
  addEventListener("scroll", onScroll, { passive: true });
  onScroll();

  // Mobile menu
  const btn = document.getElementById("menu-btn");
  const menu = document.getElementById("mobile-menu");
  btn?.addEventListener("click", () => {
    const open = menu.classList.toggle("hidden") === false;
    btn.setAttribute("aria-expanded", String(open));
  });
  // Close menu when a link is clicked
  menu?.addEventListener("click", (e) => {
    const a = e.target.closest("a");
    if (!a) return;
    menu.classList.add("hidden");
    btn.setAttribute("aria-expanded", "false");
  });

  // ---------- Smart section linking ----------
  // If a link targets a hash and the section isn't on the current page,
  // route to "/#hash" instead (works from /projects and detail pages).
  const HOME = "/";
  const navLinks = [...document.querySelectorAll('a.nav-link[data-kind="hash"]')];

  navLinks.forEach((a) => {
    a.addEventListener("click", (e) => {
      const href = a.getAttribute("href"); // "#skills" etc.
      if (!href || !href.startsWith("#")) return;
      const target = document.querySelector(href);
      if (target) return; // section exists here; let default scroll happen

      e.preventDefault();
      // Navigate home with the same hash; browser will scroll to the section there.
      window.location.assign(HOME + href);
    });
  });

  // ---------- Active state ----------
  // 1) Route-level active (e.g., /projects)
  const path = location.pathname.replace(/\/+$/, "");
  document
    .querySelectorAll('a.nav-link[href="/projects"]')
    .forEach((el) => el.setAttribute("aria-current", path.startsWith("/projects") ? "true" : "false"));

  // 2) Section links get active on the landing page via your scroll-spy (FX.astro).
  //    When not on home, keep them unselected so the route highlight is clear.
  if (path !== "" && path !== "/") {
    document
      .querySelectorAll('a.nav-link[data-kind="hash"]')
      .forEach((el) => el.setAttribute("aria-current", "false"));
  }
</script>
